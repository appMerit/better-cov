{
  "codebase_path": "/Users/mreith/Marks_Code/Merit/better-cov/merit-travelops-demo/app",
  "total_contracts": 10,
  "contracts": [
    {
      "id": "contract.api-response.v1",
      "version": "1.0.0",
      "name": "TravelOps API Response Contract",
      "task_context": {
        "goal": "Return structured travel planning response with complete itinerary",
        "inputs": {},
        "constraints": [
          "Must be valid JSON",
          "Must include all required fields",
          "Must match TravelOpsResponse schema"
        ]
      },
      "output_contract": {
        "format": "json",
        "schema_definition": {},
        "required_fields": [
          "assistant_message",
          "itinerary",
          "session_id"
        ]
      },
      "obligations": [
        {
          "id": "OBL-001",
          "description": "Response must fully validate against TravelOpsResponse Pydantic model (includes all required fields, correct types, and any Field() validators)",
          "applies_to": [
            "final_response"
          ],
          "rule": "TravelOpsResponse.model_validate(response) succeeds without ValidationError",
          "validator": "jsonschema",
          "enforcement": "hard",
          "severity": "critical"
        }
      ],
      "acceptance_policy": {
        "require_all_hard_obligations": true,
        "block_on": "{<Severity.CRITICAL: 'critical'>}"
      }
    },
    {
      "id": "contract.itinerary-schema.v1",
      "version": "1.0.0",
      "name": "Itinerary Data Model Contract",
      "task_context": {
        "goal": "Ensure itinerary data structure is valid and complete",
        "inputs": {},
        "constraints": [
          "Must include destination and dates",
          "Nested objects must be valid",
          "Lists must contain valid objects"
        ]
      },
      "output_contract": {
        "format": "json",
        "schema_definition": {},
        "required_fields": [
          "destination",
          "dates",
          "flights",
          "hotels",
          "activities"
        ]
      },
      "obligations": [
        {
          "id": "OBL-002",
          "description": "Itinerary must fully validate against Itinerary Pydantic model (includes Location, DateRange, FlightInfo, HotelInfo, Activity nested models)",
          "applies_to": [
            "itinerary"
          ],
          "rule": "Itinerary.model_validate(itinerary_data) succeeds without ValidationError",
          "validator": "jsonschema",
          "enforcement": "hard",
          "severity": "critical"
        }
      ],
      "acceptance_policy": {
        "require_all_hard_obligations": true,
        "block_on": "{<Severity.CRITICAL: 'critical'>}"
      }
    },
    {
      "id": "contract.date-format.v1",
      "version": "1.0.0",
      "name": "ISO 8601 Date Format Requirement",
      "task_context": {
        "goal": "Ensure all dates use consistent YYYY-MM-DD format",
        "inputs": {},
        "constraints": [
          "Must match ISO 8601 YYYY-MM-DD pattern",
          "Applies to all date fields in schemas and tool outputs"
        ]
      },
      "output_contract": {
        "format": "text",
        "schema_definition": {},
        "required_fields": []
      },
      "obligations": [
        {
          "id": "OBL-003",
          "description": "All date strings must match YYYY-MM-DD format (ISO 8601) as specified in schemas.py lines 18-19, 27, 37-38, 47",
          "applies_to": [
            "all"
          ],
          "rule": "re.match(r'^\\d{4}-\\d{2}-\\d{2}$', date_string) is not None",
          "validator": "deterministic_check",
          "enforcement": "hard",
          "severity": "critical"
        }
      ],
      "acceptance_policy": {
        "require_all_hard_obligations": true,
        "block_on": "{<Severity.CRITICAL: 'critical'>}"
      }
    },
    {
      "id": "contract.llm-safety.v1",
      "version": "1.0.0",
      "name": "LLM Safety and Factual Accuracy Requirements",
      "task_context": {
        "goal": "Ensure LLM produces safe, accurate, grounded responses",
        "inputs": {},
        "constraints": [
          "Never fabricate facts",
          "Always use knowledge base",
          "Cite sources for factual claims"
        ]
      },
      "output_contract": {
        "format": "json",
        "schema_definition": {},
        "required_fields": []
      },
      "obligations": [
        {
          "id": "OBL-004",
          "description": "LLM must only use facts from provided knowledge base, never invent information (prompting.py line 95: 'Never invent facts not in the provided context')",
          "applies_to": [
            "all"
          ],
          "rule": "All factual claims in assistant_message are grounded in provided context documents from knowledge base",
          "validator": "rubric",
          "enforcement": "hard",
          "severity": "critical"
        },
        {
          "id": "OBL-005",
          "description": "When stating facts, reference the knowledge base source (prompting.py line 96: 'Always cite knowledge base when referencing policies or facts')",
          "applies_to": [
            "all"
          ],
          "rule": "Factual statements include knowledge base citations or references",
          "validator": "rubric",
          "enforcement": "soft",
          "severity": "major"
        }
      ],
      "acceptance_policy": {
        "require_all_hard_obligations": true,
        "block_on": "{<Severity.CRITICAL: 'critical'>}"
      }
    },
    {
      "id": "contract.config-constraints.v1",
      "version": "1.0.0",
      "name": "Agent Configuration Parameter Constraints",
      "task_context": {
        "goal": "Ensure agent configuration stays within safe bounds",
        "inputs": {},
        "constraints": [
          "Temperature must be 0-1",
          "Max steps must be positive",
          "Valid LLM provider"
        ]
      },
      "output_contract": {
        "format": "text",
        "schema_definition": {},
        "required_fields": []
      },
      "obligations": [
        {
          "id": "OBL-006",
          "description": "Temperature parameter must be between 0.0 and 1.0 (config.py line 22, llm_client.py line 182)",
          "applies_to": [
            "all"
          ],
          "rule": "0.0 <= config.temperature <= 1.0",
          "validator": "deterministic_check",
          "enforcement": "hard",
          "severity": "critical"
        },
        {
          "id": "OBL-007",
          "description": "max_agent_steps must be a positive integer (config.py line 23, agent.py line 148)",
          "applies_to": [
            "all"
          ],
          "rule": "config.max_agent_steps > 0 and isinstance(config.max_agent_steps, int)",
          "validator": "deterministic_check",
          "enforcement": "hard",
          "severity": "major"
        },
        {
          "id": "OBL-008",
          "description": "LLM provider must be either 'stub' or 'openai' (config.py line 21, llm_client.py line 225)",
          "applies_to": [
            "all"
          ],
          "rule": "config.llm_provider.lower() in ['stub', 'openai']",
          "validator": "deterministic_check",
          "enforcement": "hard",
          "severity": "major"
        }
      ],
      "acceptance_policy": {
        "require_all_hard_obligations": true,
        "block_on": "{<Severity.MAJOR: 'major'>, <Severity.CRITICAL: 'critical'>}"
      }
    },
    {
      "id": "contract.output-format.v1",
      "version": "1.0.0",
      "name": "JSON Output Format Contract",
      "task_context": {
        "goal": "Ensure LLM always produces valid JSON in expected format",
        "inputs": {},
        "constraints": [
          "Must be valid JSON",
          "Must match expected structure",
          "OpenAI uses JSON mode"
        ]
      },
      "output_contract": {
        "format": "json",
        "schema_definition": {},
        "required_fields": [
          "assistant_message",
          "itinerary"
        ]
      },
      "obligations": [
        {
          "id": "OBL-009",
          "description": "LLM output must be valid JSON (prompting.py line 80: 'Always respond with valid JSON')",
          "applies_to": [
            "llm_response"
          ],
          "rule": "json.loads(llm_output) succeeds without JSONDecodeError",
          "validator": "deterministic_check",
          "enforcement": "hard",
          "severity": "critical"
        },
        {
          "id": "OBL-010",
          "description": "OpenAI requests must use JSON mode via response_format parameter (llm_client.py line 183)",
          "applies_to": [
            "openai_calls"
          ],
          "rule": "kwargs['response_format'] == {'type': 'json_object'} when tools not used",
          "validator": "deterministic_check",
          "enforcement": "hard",
          "severity": "major"
        }
      ],
      "acceptance_policy": {
        "require_all_hard_obligations": true,
        "block_on": "{<Severity.CRITICAL: 'critical'>}"
      }
    },
    {
      "id": "contract.knowledge-base.v1",
      "version": "1.0.0",
      "name": "Knowledge Base Usage Contract",
      "task_context": {
        "goal": "Ensure knowledge base is properly used for contextual information",
        "inputs": {},
        "constraints": [
          "Only use provided context",
          "Respect user preferences from session memory"
        ]
      },
      "output_contract": {
        "format": "json",
        "schema_definition": {},
        "required_fields": []
      },
      "obligations": [
        {
          "id": "OBL-011",
          "description": "Agent must use tools for real-time data (prompting.py line 97: 'Use tools for real-time data (weather, availability)')",
          "applies_to": [
            "all"
          ],
          "rule": "When prompt requests weather, flights, or hotels, corresponding tool must be invoked",
          "validator": "rubric",
          "enforcement": "soft",
          "severity": "major"
        },
        {
          "id": "OBL-012",
          "description": "Agent must respect user preferences from session memory (prompting.py line 98)",
          "applies_to": [
            "all"
          ],
          "rule": "Responses incorporate preferences from session_memory when available (budget, seat preferences, etc.)",
          "validator": "rubric",
          "enforcement": "soft",
          "severity": "minor"
        }
      ],
      "acceptance_policy": {
        "require_all_hard_obligations": false,
        "block_on": "{<Severity.CRITICAL: 'critical'>}"
      }
    },
    {
      "id": "contract.retrieval-routing.v1",
      "version": "1.0.0",
      "name": "Intelligent Routing Contract",
      "task_context": {
        "goal": "Route requests appropriately to retrieval and tools",
        "inputs": {},
        "constraints": [
          "Retrieval for policy/requirement questions",
          "Tools for real-time data"
        ]
      },
      "output_contract": {
        "format": "json",
        "schema_definition": {},
        "required_fields": []
      },
      "obligations": [
        {
          "id": "OBL-013",
          "description": "Routing must trigger retrieval for policy keywords (router.py lines 19-30)",
          "applies_to": [
            "routing"
          ],
          "rule": "When prompt contains keywords ['visa', 'tipping', 'culture', 'budget', 'policy', 'requirement', 'custom'], needs_retrieval must be True",
          "validator": "deterministic_check",
          "enforcement": "hard",
          "severity": "major"
        },
        {
          "id": "OBL-014",
          "description": "Routing must trigger appropriate tools based on request (router.py lines 14-38)",
          "applies_to": [
            "routing"
          ],
          "rule": "Weather keywords \u2192 get_weather tool; Hotel keywords \u2192 search_hotels tool; Flight keywords \u2192 search_flights tool",
          "validator": "deterministic_check",
          "enforcement": "hard",
          "severity": "major"
        }
      ],
      "acceptance_policy": {
        "require_all_hard_obligations": true,
        "block_on": "{<Severity.MAJOR: 'major'>, <Severity.CRITICAL: 'critical'>}"
      }
    },
    {
      "id": "contract.tool-output.v1",
      "version": "1.0.0",
      "name": "Tool Output Format Contract",
      "task_context": {
        "goal": "Ensure all tools return consistent structured data",
        "inputs": {},
        "constraints": [
          "Must return dict with required keys",
          "Date formats must be consistent"
        ]
      },
      "output_contract": {
        "format": "json",
        "schema_definition": {},
        "required_fields": []
      },
      "obligations": [
        {
          "id": "OBL-015",
          "description": "get_weather tool must return dict with required keys (weather.py lines 18-25)",
          "applies_to": [
            "tool:get_weather"
          ],
          "rule": "Result contains keys: ['location', 'date', 'temperature', 'condition', 'humidity', 'wind_speed']",
          "validator": "deterministic_check",
          "enforcement": "hard",
          "severity": "major"
        },
        {
          "id": "OBL-016",
          "description": "search_hotels tool must return dict with required structure (hotels.py lines 52-58)",
          "applies_to": [
            "tool:search_hotels"
          ],
          "rule": "Result contains keys: ['location', 'check_in', 'check_out', 'hotels', 'count'] and hotels is list",
          "validator": "deterministic_check",
          "enforcement": "hard",
          "severity": "major"
        },
        {
          "id": "OBL-017",
          "description": "search_flights tool must return dict with required structure (flights.py lines 61-67)",
          "applies_to": [
            "tool:search_flights"
          ],
          "rule": "Result contains keys: ['from', 'to', 'date', 'flights', 'count'] and flights is list",
          "validator": "deterministic_check",
          "enforcement": "hard",
          "severity": "major"
        }
      ],
      "acceptance_policy": {
        "require_all_hard_obligations": true,
        "block_on": "{<Severity.MAJOR: 'major'>, <Severity.CRITICAL: 'critical'>}"
      }
    },
    {
      "id": "contract.agent-termination.v1",
      "version": "1.0.0",
      "name": "Agent Termination Policy",
      "task_context": {
        "goal": "Prevent infinite loops by enforcing max steps",
        "inputs": {},
        "constraints": [
          "Must respect max_agent_steps configuration",
          "Must track step count"
        ]
      },
      "output_contract": {
        "format": "text",
        "schema_definition": {},
        "required_fields": []
      },
      "obligations": [
        {
          "id": "OBL-018",
          "description": "Agent must stop when max_agent_steps is reached (agent.py lines 148-150)",
          "applies_to": [
            "agent_loop"
          ],
          "rule": "When step >= config.max_agent_steps, should_stop() returns (True, 'max_steps_reached')",
          "validator": "deterministic_check",
          "enforcement": "hard",
          "severity": "critical"
        }
      ],
      "acceptance_policy": {
        "require_all_hard_obligations": true,
        "block_on": "{<Severity.CRITICAL: 'critical'>}"
      }
    }
  ],
  "summary": "Discovered 10 contracts with 18 obligations across TravelOps demo application. Key contract categories: (1) Schema Validation - 2 jsonschema obligations for TravelOpsResponse and Itinerary models ensuring complete validation of all fields, types, and nested structures; (2) Data Format - 1 deterministic_check for ISO 8601 date format (YYYY-MM-DD); (3) LLM Safety - 2 rubric obligations for fact grounding and source citation per system prompt policies; (4) Configuration - 3 deterministic_check obligations for temperature bounds (0-1), positive max_steps, and valid provider; (5) Output Format - 2 deterministic_check obligations for JSON validity and OpenAI JSON mode; (6) Knowledge Base - 2 rubric obligations for tool usage and user preference respect; (7) Routing - 2 deterministic_check obligations for keyword-based retrieval and tool routing logic; (8) Tool Outputs - 3 deterministic_check obligations ensuring weather, hotel, and flight tools return required dictionary keys; (9) Agent Termination - 1 deterministic_check for max steps enforcement. Enforcement: 14 hard/4 soft. Severity: 6 critical/10 major/2 minor. All obligations cite exact file:line locations for traceability."
}