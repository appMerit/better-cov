{
  "contracts": [
    {
      "name": "Response Schema Contract",
      "obligations": [
        {
          "id": "OBL-SCHEMA-001",
          "location": "app/schemas.py:63-68",
          "description": "TravelOpsResponse must contain assistant_message (str), itinerary (dict), and session_id (str)",
          "rule": "jsonschema: TravelOpsResponse.model_validate(payload) succeeds with all three required fields present",
          "enforcement": "hard",
          "severity": "critical"
        },
        {
          "id": "OBL-SCHEMA-002",
          "location": "tests/fixtures/expected_schemas.py:46-49",
          "description": "Response dict must have assistant_message, itinerary, and session_id keys",
          "rule": "deterministic_check: all(field in response for field in ['assistant_message', 'itinerary', 'session_id'])",
          "enforcement": "hard",
          "severity": "critical"
        },
        {
          "id": "OBL-SCHEMA-003",
          "location": "tests/merit_travelops_contract.py:38-41",
          "description": "assistant_message must be a string type",
          "rule": "deterministic_check: isinstance(response.assistant_message, str)",
          "enforcement": "hard",
          "severity": "major"
        },
        {
          "id": "OBL-SCHEMA-004",
          "location": "tests/merit_travelops_contract.py:43-44",
          "description": "itinerary field must be present and not None",
          "rule": "deterministic_check: response.itinerary is not None",
          "enforcement": "hard",
          "severity": "critical"
        }
      ]
    },
    {
      "name": "Itinerary Structure Contract",
      "obligations": [
        {
          "id": "OBL-ITIN-001",
          "location": "app/schemas.py:51-60",
          "description": "Itinerary must have destination (Location), dates (DateRange), flights, hotels, activities lists, optional budget and notes",
          "rule": "jsonschema: Itinerary.model_validate(itinerary_payload) succeeds",
          "enforcement": "hard",
          "severity": "critical"
        },
        {
          "id": "OBL-ITIN-002",
          "location": "tests/fixtures/expected_schemas.py:17-22",
          "description": "Destination must be a dict with 'city' and 'country' string keys",
          "rule": "deterministic_check: isinstance(itinerary['destination'], dict) and 'city' in itinerary['destination'] and 'country' in itinerary['destination']",
          "enforcement": "hard",
          "severity": "critical"
        },
        {
          "id": "OBL-ITIN-003",
          "location": "tests/fixtures/expected_schemas.py:24-30",
          "description": "Dates must be a dict with 'start_date' and 'end_date' keys in YYYY-MM-DD format",
          "rule": "deterministic_check: isinstance(itinerary['dates'], dict) and 'start_date' in itinerary['dates'] and 'end_date' in itinerary['dates']",
          "enforcement": "hard",
          "severity": "critical"
        },
        {
          "id": "OBL-ITIN-004",
          "location": "tests/fixtures/expected_schemas.py:32-36",
          "description": "Flights, hotels, and activities must be list types",
          "rule": "deterministic_check: isinstance(itinerary.get('flights', []), list) and isinstance(itinerary.get('hotels', []), list) and isinstance(itinerary.get('activities', []), list)",
          "enforcement": "hard",
          "severity": "major"
        },
        {
          "id": "OBL-ITIN-005",
          "location": "tests/fixtures/expected_schemas.py:38-41",
          "description": "Budget, if present, must be numeric (int or float)",
          "rule": "deterministic_check: itinerary['budget'] is None or isinstance(itinerary['budget'], (int, float))",
          "enforcement": "hard",
          "severity": "major"
        },
        {
          "id": "OBL-ITIN-006",
          "location": "app/postprocess.py:33-36",
          "description": "Date fields must never be None; fallback to '2024-01-01' if missing",
          "rule": "deterministic_check: itinerary['dates']['start_date'] is not None and itinerary['dates']['end_date'] is not None",
          "enforcement": "hard",
          "severity": "major"
        }
      ]
    },
    {
      "name": "Nested Schema Contracts",
      "obligations": [
        {
          "id": "OBL-NESTED-001",
          "location": "app/schemas.py:8-12",
          "description": "Location schema requires city (str) and country (str)",
          "rule": "jsonschema: Location.model_validate(location) succeeds",
          "enforcement": "hard",
          "severity": "major"
        },
        {
          "id": "OBL-NESTED-002",
          "location": "app/schemas.py:15-19",
          "description": "DateRange requires start_date and end_date as strings in YYYY-MM-DD format",
          "rule": "jsonschema: DateRange.model_validate(dates) succeeds",
          "enforcement": "hard",
          "severity": "major"
        },
        {
          "id": "OBL-NESTED-003",
          "location": "app/schemas.py:22-29",
          "description": "FlightInfo requires departure, arrival, date strings; airline and price are optional",
          "rule": "jsonschema: FlightInfo.model_validate(flight) succeeds",
          "enforcement": "soft",
          "severity": "minor"
        },
        {
          "id": "OBL-NESTED-004",
          "location": "app/schemas.py:32-39",
          "description": "HotelInfo requires name, location, check_in, check_out; price_per_night is optional",
          "rule": "jsonschema: HotelInfo.model_validate(hotel) succeeds",
          "enforcement": "soft",
          "severity": "minor"
        },
        {
          "id": "OBL-NESTED-005",
          "location": "app/schemas.py:42-48",
          "description": "Activity requires name and location; date and description are optional",
          "rule": "jsonschema: Activity.model_validate(activity) succeeds",
          "enforcement": "soft",
          "severity": "minor"
        }
      ]
    },
    {
      "name": "LLM Output Format Contract",
      "obligations": [
        {
          "id": "OBL-LLM-001",
          "location": "app/prompting.py:79-92",
          "description": "LLM must respond with valid JSON containing assistant_message and itinerary fields matching specified structure",
          "rule": "rubric: System prompt mandates JSON output with exact structure: {\"assistant_message\": \"...\", \"itinerary\": {...}}",
          "enforcement": "hard",
          "severity": "critical"
        },
        {
          "id": "OBL-LLM-002",
          "location": "app/postprocess.py:62-96",
          "description": "LLM response must be parseable as JSON or contain JSON in markdown code blocks",
          "rule": "deterministic_check: json.loads(response['content']) succeeds OR regex r'```json\\s*(.*?)\\s*```' matches",
          "enforcement": "hard",
          "severity": "critical"
        },
        {
          "id": "OBL-LLM-003",
          "location": "app/llm_client.py:183",
          "description": "OpenAI calls must use response_format: json_object to enforce JSON output",
          "rule": "deterministic_check: 'response_format' in openai_kwargs and openai_kwargs['response_format']['type'] == 'json_object'",
          "enforcement": "hard",
          "severity": "major"
        }
      ]
    },
    {
      "name": "System Prompt Policy Contract",
      "obligations": [
        {
          "id": "OBL-POLICY-001",
          "location": "app/prompting.py:95",
          "description": "Agent must never invent facts not in provided context",
          "rule": "rubric: Check that assistant responses only reference information from provided context_docs, tool_results, or knowledge base. Flag any facts not traceable to these sources.",
          "enforcement": "soft",
          "severity": "major"
        },
        {
          "id": "OBL-POLICY-002",
          "location": "app/prompting.py:96",
          "description": "Agent must cite knowledge base when referencing policies or facts",
          "rule": "rubric: When assistant mentions visa requirements, tipping customs, weather, or budget info, verify it matches content from KB_DOCUMENTS in app/retrieval.py:9-60",
          "enforcement": "soft",
          "severity": "minor"
        },
        {
          "id": "OBL-POLICY-003",
          "location": "app/prompting.py:97",
          "description": "Agent must use tools for real-time data (weather, availability)",
          "rule": "rubric: When user asks about weather, hotel availability, or flights, routing_decision['needs_tools'] should be True",
          "enforcement": "soft",
          "severity": "minor"
        },
        {
          "id": "OBL-POLICY-004",
          "location": "app/prompting.py:98",
          "description": "Agent must respect user preferences from session memory",
          "rule": "rubric: If session_memory contains preferences (e.g., budget, seat_preference), final itinerary should align with those preferences",
          "enforcement": "soft",
          "severity": "minor"
        }
      ]
    },
    {
      "name": "Configuration Constraints",
      "obligations": [
        {
          "id": "OBL-CONFIG-001",
          "location": "app/config.py:22",
          "description": "Temperature must be 0.0 for deterministic outputs",
          "rule": "deterministic_check: config.temperature == 0.0",
          "enforcement": "hard",
          "severity": "major"
        },
        {
          "id": "OBL-CONFIG-002",
          "location": "app/config.py:23",
          "description": "Max agent steps must not exceed 5 to prevent infinite loops",
          "rule": "deterministic_check: config.max_agent_steps <= 5",
          "enforcement": "hard",
          "severity": "major"
        },
        {
          "id": "OBL-CONFIG-003",
          "location": "app/agent.py:148-150",
          "description": "Agent must terminate when step count reaches max_agent_steps",
          "rule": "deterministic_check: step >= config.max_agent_steps implies should_stop returns (True, 'max_steps_reached')",
          "enforcement": "hard",
          "severity": "critical"
        },
        {
          "id": "OBL-CONFIG-004",
          "location": "app/llm_client.py:226-227",
          "description": "When llm_provider is 'openai', OPENAI_API_KEY must be set",
          "rule": "deterministic_check: config.llm_provider != 'openai' or config.openai_api_key is not None",
          "enforcement": "hard",
          "severity": "critical"
        }
      ]
    },
    {
      "name": "Routing Decision Contract",
      "obligations": [
        {
          "id": "OBL-ROUTE-001",
          "location": "app/router.py:14",
          "description": "Weather keyword in prompt must trigger get_weather tool",
          "rule": "deterministic_check: 'weather' in prompt.lower() implies 'get_weather' in routing_decision['tools']",
          "enforcement": "hard",
          "severity": "major"
        },
        {
          "id": "OBL-ROUTE-002",
          "location": "app/router.py:15-16",
          "description": "Hotel or accommodation keywords must trigger search_hotels tool",
          "rule": "deterministic_check: ('hotel' in prompt.lower() or 'accommodation' in prompt.lower()) implies 'search_hotels' in routing_decision['tools']",
          "enforcement": "hard",
          "severity": "major"
        },
        {
          "id": "OBL-ROUTE-003",
          "location": "app/router.py:16",
          "description": "Flight keyword must trigger search_flights tool",
          "rule": "deterministic_check: 'flight' in prompt.lower() implies 'search_flights' in routing_decision['tools']",
          "enforcement": "hard",
          "severity": "major"
        },
        {
          "id": "OBL-ROUTE-004",
          "location": "app/router.py:19-30",
          "description": "Keywords (visa, tipping, culture, budget, policy, requirement, custom) must trigger retrieval",
          "rule": "deterministic_check: any(kw in prompt.lower() for kw in ['visa', 'tipping', 'culture', 'budget', 'policy', 'requirement', 'custom']) implies routing_decision['needs_retrieval'] == True",
          "enforcement": "hard",
          "severity": "major"
        }
      ]
    },
    {
      "name": "Tool Execution Contract",
      "obligations": [
        {
          "id": "OBL-TOOL-001",
          "location": "app/tools/flights.py:8-9",
          "description": "search_flights must accept from_location, to_location, date, and optional budget parameters",
          "rule": "deterministic_check: function signature matches def search_flights(from_location: str, to_location: str, date: str, budget: str | None = None)",
          "enforcement": "hard",
          "severity": "major"
        },
        {
          "id": "OBL-TOOL-002",
          "location": "app/tools/hotels.py:8-9",
          "description": "search_hotels must accept location, check_in, check_out, and optional budget parameters",
          "rule": "deterministic_check: function signature matches def search_hotels(location: str, check_in: str, check_out: str, budget: str | None = None)",
          "enforcement": "hard",
          "severity": "major"
        },
        {
          "id": "OBL-TOOL-003",
          "location": "app/tools/weather.py:8",
          "description": "get_weather must accept location and optional date parameters",
          "rule": "deterministic_check: function signature matches def get_weather(location: str, date: str | None = None)",
          "enforcement": "hard",
          "severity": "major"
        },
        {
          "id": "OBL-TOOL-004",
          "location": "app/agent.py:125-127",
          "description": "Tool execution errors must be caught and returned as error results, not raised",
          "rule": "deterministic_check: try-except block wraps tool calls and exceptions produce {'tool_name': name, 'output': f'Error: {str(e)}'} dict",
          "enforcement": "hard",
          "severity": "major"
        }
      ]
    },
    {
      "name": "Session State Contract",
      "obligations": [
        {
          "id": "OBL-STATE-001",
          "location": "app/state.py:14",
          "description": "load_session must return dict with 'preferences' and 'history' keys, even for new sessions",
          "rule": "deterministic_check: 'preferences' in load_session(session_id) and 'history' in load_session(session_id)",
          "enforcement": "hard",
          "severity": "major"
        },
        {
          "id": "OBL-STATE-002",
          "location": "app/state.py:35-37",
          "description": "update_session_memory must append to history list with prompt and response",
          "rule": "deterministic_check: after update_session_memory, new entry in session_data['history'] with keys 'prompt' and 'response'",
          "enforcement": "hard",
          "severity": "minor"
        },
        {
          "id": "OBL-STATE-003",
          "location": "app/agent.py:27-28",
          "description": "If session_id is None, agent must generate a new UUID",
          "rule": "deterministic_check: session_id is None implies session_id = str(uuid.uuid4()) before processing",
          "enforcement": "hard",
          "severity": "major"
        }
      ]
    },
    {
      "name": "Normalization Contract",
      "obligations": [
        {
          "id": "OBL-NORM-001",
          "location": "app/postprocess.py:16-21",
          "description": "normalize_itinerary must validate against Itinerary schema and return model_dump on success",
          "rule": "deterministic_check: try Itinerary(**raw_itinerary).model_dump(); on success return normalized dict",
          "enforcement": "hard",
          "severity": "critical"
        },
        {
          "id": "OBL-NORM-002",
          "location": "app/postprocess.py:22-59",
          "description": "On validation failure, normalize_itinerary must salvage data with fallback values (Unknown city/country, 2024-01-01 dates)",
          "rule": "deterministic_check: on ValidationError, construct dict with destination={'city': fallback, 'country': fallback}, dates={'start_date': fallback_date, 'end_date': fallback_date}, empty lists for flights/hotels/activities",
          "enforcement": "hard",
          "severity": "major"
        },
        {
          "id": "OBL-NORM-003",
          "location": "app/agent.py:73-85",
          "description": "If raw_itinerary is empty/None, create minimal valid itinerary with Unknown destination and default dates",
          "rule": "deterministic_check: not raw_itinerary implies itinerary = {'destination': {'city': 'Unknown', 'country': 'Unknown'}, 'dates': {'start_date': '2024-01-01', 'end_date': '2024-01-01'}, 'flights': [], 'hotels': [], 'activities': [], 'budget': None, 'notes': assistant_message}",
          "enforcement": "hard",
          "severity": "major"
        }
      ]
    },
    {
      "name": "Tracing Contract",
      "obligations": [
        {
          "id": "OBL-TRACE-001",
          "location": "app/agent.py:30-36",
          "description": "Agent run must be wrapped in trace_operation with session_id and prompt_length attributes",
          "rule": "deterministic_check: agent.run entry point uses trace_operation context manager with operation name 'travelops.agent.run'",
          "enforcement": "soft",
          "severity": "minor"
        },
        {
          "id": "OBL-TRACE-002",
          "location": "app/agent.py:61-68",
          "description": "LLM generation must be traced with provider and temperature attributes",
          "rule": "deterministic_check: llm_client.generate wrapped in trace_operation with 'travelops.llm.generate' and attributes llm.provider, llm.temperature",
          "enforcement": "soft",
          "severity": "minor"
        },
        {
          "id": "OBL-TRACE-003",
          "location": "app/tools/flights.py:15-21",
          "description": "Tool calls must be traced with tool.name and tool.args attributes",
          "rule": "deterministic_check: each tool function (search_flights, search_hotels, get_weather) uses trace_operation('travelops.tool.call') with tool.name and serialized tool.args",
          "enforcement": "soft",
          "severity": "minor"
        }
      ]
    },
    {
      "name": "Termination Validation Contract",
      "obligations": [
        {
          "id": "OBL-TERM-001",
          "location": "tests/fixtures/expected_schemas.py:52-58",
          "description": "Valid termination reasons are limited to: max_steps_reached, complete, success, tool_complete, final_answer",
          "rule": "deterministic_check: termination_reason in ['max_steps_reached', 'complete', 'success', 'tool_complete', 'final_answer']",
          "enforcement": "hard",
          "severity": "minor"
        },
        {
          "id": "OBL-TERM-002",
          "location": "app/agent.py:149-150",
          "description": "When max_steps reached, should_stop must return (True, 'max_steps_reached')",
          "rule": "deterministic_check: step >= config.max_agent_steps implies should_stop returns (True, 'max_steps_reached')",
          "enforcement": "hard",
          "severity": "major"
        }
      ]
    }
  ]
}